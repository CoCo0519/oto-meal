# 批量小波降噪处理工具

这是一个专门用于批量处理所有数据目录的小波降噪工具，可以一次性处理项目中的所有 `xxx_data` 目录。

## 功能特点

✅ **自动发现**：自动扫描并识别所有 xxx_data 格式的目录
✅ **多通道处理**：同时处理所有PPG通道（green、ir、red）和IMU数据
✅ **多种方法**：支持小波降噪和Bayesian降噪两种方法
✅ **图形化配置**：直观的 GUI 界面选择处理参数和方法
✅ **进度跟踪**：实时显示处理进度和状态
✅ **结果汇总**：生成详细的批量处理报告
✅ **灵活选择**：可选择特定目录或处理全部目录

## 文件结构

```
batch_all_wavelet_denoise.py    # 主批量处理脚本
batch_all_denoise.py            # 便捷运行脚本
batch_denoise_config.json       # 默认批量配置
BATCH_DENOISE_README.md         # 本说明文档
```

## 快速开始

### 1. 自动处理所有数据目录（推荐）

```bash
python batch_all_wavelet_denoise.py
```

或使用便捷脚本：

```bash
python batch_all_denoise.py --auto
```

### 2. 使用配置文件

```bash
python batch_all_denoise.py --config batch_denoise_config.json
```

### 3. 指定特定目录

```bash
python batch_all_denoise.py --dirs hyx_data lhr_data
```

## 配置参数

### 自动发现的目录
工具会自动扫描并识别以下格式的目录：
- `hyx_data` - 包含 10 个 txt 文件
- `lhr_data` - 包含 10 个 txt 文件
- `lj_data` - 包含 2 个 txt 文件

### 降噪参数
- **采样率 (fs)**: 数据采样频率，默认为 100 Hz
- **PPG通道**: 选择要处理的 PPG 通道 (green/ir/red)
- **小波类型**: 选择小波基函数
- **分解层数**: 小波分解的层数
- **阈值策略**: 通用阈值或手动阈值
- **处理选项**: 可分别控制 PPG 和 IMU 降噪

## 输出结果

### 目录结构
```
batch_denoised_results/
└── batch_all_YYYYMMDD-HHMM/
    ├── batch_config.json          # 批量配置参数
    ├── batch_summary.txt          # 处理汇总报告
    ├── denoised_hyx_YYYYMMDD-HHMM/    # hyx_data 结果
    ├── denoised_lhr_YYYYMMDD-HHMM/    # lhr_data 结果
    └── denoised_lj_YYYYMMDD-HHMM/     # lj_data 结果
```

### 汇总报告 (batch_summary.txt)
包含以下信息：
- 处理时间和配置信息
- 每个目录的处理状态
- 成功和失败的统计
- 错误信息的详细记录

### 单个目录结果
每个数据目录的处理结果与单目录处理相同，包含：
- `denoising_summary.csv` - 详细统计报告
- `wavelet_config.json` - 使用的配置参数
- `[文件名]_denoising_comparison.png` - 对比图像

## 使用示例

### 示例 1: 处理所有目录（推荐）
```bash
python batch_all_denoise.py
```
这将启动图形化界面，您可以：
1. 看到自动发现的目录列表（hyx_data, lhr_data, lj_data）
2. 选择要处理的小波参数
3. 确认开始批量处理

### 示例 2: 使用预设配置
```bash
python batch_all_denoise.py --config batch_denoise_config.json
```
使用预设的配置，跳过GUI界面直接开始处理。

### 示例 3: 只处理特定目录
```bash
python batch_all_denoise.py --dirs hyx_data lj_data
```
只处理指定的两个目录，跳过 lhr_data。

## 图形化界面说明

### 目录选择
- **自动发现**: 显示所有包含 .txt 文件的 xxx_data 目录
- **选择控制**: 勾选要处理的目录，取消勾选要跳过的目录
- **重新扫描**: 如果目录列表有变化，可以重新扫描

### 参数配置
- **基本参数**: 采样率、PPG通道选择
- **降噪方法**: 小波降噪或Bayesian降噪
- **小波参数**: 小波类型、分解层数选择
- **阈值策略**: 通用阈值、Bayesian阈值或手动阈值
- **降噪选项**: 分别控制PPG和IMU信号的降噪处理

### 进度显示
- 实时显示当前处理进度
- 显示每个目录的处理状态
- 处理完成后显示汇总结果

## 命令行选项

### 主要选项
- `--auto`: 自动发现并处理所有数据目录
- `--config FILE`: 指定配置文件路径
- `--dirs DIR1 DIR2`: 指定要处理的数据目录

### 其他选项
- `--output-dir DIR`: 指定输出基础目录
- `--help`: 显示帮助信息

## 处理流程

1. **初始化**: 扫描数据目录，加载配置
2. **验证**: 检查目录存在性和文件完整性
3. **配置**: 通过GUI或配置文件获取处理参数
4. **处理**: 依次对每个目录执行小波降噪
5. **汇总**: 生成批量处理报告和统计信息

## 性能和注意事项

### 内存使用
- 批量处理会依次处理每个目录，不同目录间相互独立
- 内存使用量与单个目录处理相同
- 大型数据集建议分批处理

### 处理时间
- 取决于数据目录的数量和大小
- 每个目录的处理时间与单目录处理相同
- 总时间 = 目录数 × 单目录处理时间

### 错误处理
- 单个目录失败不影响其他目录
- 详细的错误信息记录在汇总报告中
- 失败的目录会显示具体错误原因

## 与单目录处理的区别

| 特性 | 单目录处理 | 批量处理 |
|------|------------|----------|
| 处理范围 | 单个目录 | 多个目录 |
| 目录发现 | 手动指定 | 自动发现 |
| 配置方式 | 每次单独配置 | 统一配置 |
| 输出结构 | 独立目录 | 统一汇总 |
| 进度显示 | 单个进度 | 批量进度 |
| 报告格式 | 单个CSV | 汇总TXT+CSV |

## 故障排除

### 常见问题

1. **未发现数据目录**
   - 检查目录是否以 `_data` 结尾
   - 确保目录包含 `.txt` 文件
   - 运行时在正确的项目目录下

2. **处理失败**
   - 检查目录权限和文件完整性
   - 查看汇总报告中的详细错误信息
   - 确认配置文件格式正确

3. **GUI界面不显示**
   - 确保安装了 tkinter 库
   - Windows: `sudo apt-get install python3-tk`
   - macOS: `brew install python-tk`

### 调试模式
如果遇到问题，可以：
1. 检查 `batch_summary.txt` 中的详细错误信息
2. 手动运行单个目录处理进行测试
3. 查看控制台输出了解处理过程

## 降噪方法选择

### 小波降噪 (Wavelet Denoising)
- **原理**: 使用小波变换将信号分解为不同频率成分，然后对细节系数进行阈值处理
- **阈值策略**:
  - **通用阈值**: σ√(2lnN)，适合大多数情况
  - **Bayesian阈值**: σ²/σ_universal，更保守的阈值
  - **手动阈值**: 用户自定义阈值
- **阈值模式**: 软阈值（连续）或硬阈值（不连续）
- **优势**: 计算高效，适合实时处理

### Bayesian降噪 (Bayesian Denoising)
- **原理**: 基于Bayesian统计理论的收缩阈值方法
- **特点**:
  - 自适应阈值计算
  - 考虑信号和噪声的统计特性
  - 更保守的噪声去除策略
- **优势**: 在低信噪比情况下表现更好
- **适用场景**: 噪声水平较高或信号特征较弱的情况

### 多通道处理
- **PPG通道**: 同时处理green、ir、red三个通道
- **IMU数据**: 支持ACC（X/Y/Z轴）和GYRO（X/Y/Z轴）数据
- **独立处理**: 每个通道使用相同的参数但独立降噪
- **结果整合**: 生成每个通道的降噪结果和对比图像

## 技术原理

### 批量处理机制
1. **目录发现**: 遍历当前目录，识别 xxx_data 格式文件夹
2. **参数传递**: 通过子进程调用单目录处理脚本
3. **结果汇总**: 收集所有处理结果生成统一报告
4. **错误隔离**: 单个目录失败不影响整体处理流程

### 配置管理
- 支持GUI配置和JSON配置文件
- 批量配置可保存为JSON文件重复使用
- 目录选择和降噪参数分离管理

## 许可证

本工具遵循与原项目相同的许可证。

---

如需更详细的技术信息，请参考 `WAVELET_DENOISE_README.md`。
