# 小波降噪工具使用指南

## 概述

本工具基于 `ReadDirectory.py` 的逻辑，实现了对 PPG 和 IMU 数据的批量小波降噪处理。相比原有的模板相减和自适应噪声消除方法，小波降噪能够提供更好的噪声抑制效果和更灵活的参数控制。

## 主要特点

✅ **批量处理**：自动处理目录下所有符合要求的数据文件
✅ **图形化配置**：直观的 GUI 界面设置降噪参数
✅ **多种小波基**：支持 Daubechies、Symlets、Coiflets 等小波函数
✅ **智能阈值**：提供通用阈值和手动阈值两种策略
✅ **可视化对比**：生成降噪前后的详细对比图像
✅ **统计报告**：输出包含信噪比改善等详细指标的 CSV 报告
✅ **独立控制**：可分别控制 PPG 和 IMU 信号的降噪处理

## 快速开始

### 1. 基本使用（推荐首次使用）

```bash
python wavelet_denoise_batch.py --dir ./hyx_data
```

或使用便捷脚本：

```bash
python run_wavelet_denoise.py --dir ./hyx_data
```

首次运行时会启动图形化配置界面，您可以：

- 选择 PPG 通道（绿光/IR/红光）
- 选择小波基函数（推荐 db6 或 sym8）
- 设置分解层数（推荐 4-6 层）
- 选择阈值策略（推荐通用阈值）
- 决定是否对 IMU 数据进行降噪

### 2. 使用配置文件

```bash
python wavelet_denoise_batch.py --dir ./hyx_data --config my_config.json
```

## 配置参数详解

### 基本参数
- **采样率 (fs)**: 数据采样频率，默认为 100 Hz
- **PPG通道**: 选择要处理的 PPG 通道

### 小波参数
- **小波类型**: 选择合适的小波基函数
  - `db1-db8`: Daubechies 小波（推荐 db6）
  - `sym2-sym8`: Symlets 小波（推荐 sym8）
  - `coif1-coif5`: Coiflets 小波
- **分解层数**: 小波分解层数，影响降噪效果和计算量
- **边界模式**: 信号边界处理方式

### 阈值参数
- **阈值策略**:
  - `universal`: 自动计算阈值（推荐）
  - `manual`: 手动指定阈值
- **阈值缩放**: 通用阈值的缩放因子
- **阈值模式**: `soft`（软阈值）或 `hard`（硬阈值）

## 输出结果

### 目录结构
```
denoised_[数据源]_[时间戳]/
├── denoising_summary.csv          # 详细统计报告
├── wavelet_config.json            # 使用的配置参数
└── [文件名]_denoising_comparison.png  # 对比图像
```

### 可视化图像
每个文件生成一个 4x2 的对比图像，包含：

- **PPG对比**: 原始信号 vs 降噪信号 vs 残差
- **ACC对比**: X/Y/Z 三轴的原始 vs 降噪对比
- **GYRO对比**: 三轴陀螺仪数据（如果存在）

### 统计报告
CSV 文件包含以下关键指标：

- 文件基本信息（采样点数、时长等）
- 降噪参数设置
- PPG 信噪比改善情况
- IMU 信号能量变化
- 处理状态和错误信息

## 使用示例

### 示例 1: 基础配置
```json
{
  "fs": 100,
  "channel": "green",
  "wavelet": "db6",
  "decomposition_level": 4,
  "mode": "symmetric",
  "threshold": {
    "strategy": "universal",
    "scale": 1.0,
    "manual_value": null,
    "threshold_mode": "soft"
  },
  "ppg_denoise": true,
  "imu_denoise": true
}
```

### 示例 2: 高级配置
```json
{
  "fs": 100,
  "channel": "green",
  "wavelet": "sym8",
  "decomposition_level": 5,
  "mode": "symmetric",
  "threshold": {
    "strategy": "manual",
    "scale": 1.0,
    "manual_value": 0.1,
    "threshold_mode": "soft"
  },
  "ppg_denoise": true,
  "imu_denoise": false
}
```

## 与原 ReadDirectory.py 的区别

| 特性 | ReadDirectory.py | 小波降噪工具 |
|------|------------------|--------------|
| 降噪方法 | 模板相减 + ANC | 小波近似 |
| 参数配置 | 命令行参数 | GUI + 配置文件 |
| 输出格式 | 4行对比图 | 4x2对比图 |
| 统计指标 | 残差标准差等 | 信噪比改善等 |
| 处理对象 | 同时处理PPG/IMU | 可独立控制 |
| 可视化 | 基本对比 | 详细对比 + 残差 |

## 性能优化建议

### 小波选择
- **推荐**: db6, sym8
- **计算量**: db1 < sym2 < coif1 < db8
- **效果**: 较高阶小波通常有更好的降噪效果

### 参数调整
- **分解层数**: 4-6 层最常用
- **阈值策略**: universal 通常效果最好
- **阈值模式**: soft 优于 hard
- **阈值缩放**: 0.8-1.2 范围调整

### 内存优化
- 大文件处理时可降低分解层数
- 关闭不需要的 IMU 降噪以减少计算量
- 使用较小的小波基函数

## 故障排除

### 常见问题

1. **内存不足**
   - 降低分解层数
   - 分批处理大文件

2. **降噪过度**
   - 降低阈值缩放因子
   - 使用 manual 策略调整阈值

3. **降噪不足**
   - 提高阈值缩放因子
   - 增加分解层数

4. **GUI 界面不显示**
   - 确保安装了 tkinter
   - Windows: `sudo apt-get install python3-tk`
   - macOS: `brew install python-tk`

### 错误信息处理

- `pywt is required`: 安装 PyWavelets
- `Config file not found`: 检查配置文件路径
- `UnicodeDecodeError`: 尝试指定文件编码格式

## 技术原理

### 小波降噪过程
1. **小波分解**: 将信号分解为近似系数和细节系数
2. **阈值处理**: 对细节系数应用阈值收缩
3. **信号重构**: 使用处理后的系数重构信号

### 阈值计算
- **通用阈值**: σ√(2lnN)，σ 为噪声标准差
- **软阈值**: 收缩到 0，保持连续性
- **硬阈值**: 小于阈值置零，大于阈值保持不变

## 许可证

本工具遵循与原项目相同的许可证。

---

如有问题或建议，请参考 `WAVELET_DENOISE_README.md` 获取更详细的技术文档。
