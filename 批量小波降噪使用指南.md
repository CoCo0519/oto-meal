# 批量小波降噪使用指南

## 概述

批量小波降噪工具可以一次性自动发现并处理项目中的所有 `xxx_data` 目录，实现高效的批量数据处理。相比逐个处理目录，这种方式更加便捷和高效。

## 功能特点

✅ **智能发现**：自动扫描项目中的所有 xxx_data 目录
✅ **多通道处理**：同时处理所有PPG通道（green、ir、red）和IMU数据
✅ **多种方法**：支持小波降噪和Bayesian降噪两种方法
✅ **一键处理**：无需逐个指定目录，自动处理所有发现的目录
✅ **统一配置**：所有目录使用相同的降噪参数
✅ **进度监控**：实时显示处理进度和状态
✅ **结果汇总**：生成详细的批量处理报告
✅ **错误隔离**：单个目录失败不影响整体处理

## 快速开始

### 1. 自动处理所有目录（推荐）

```bash
python batch_all_wavelet_denoise.py
```

或使用便捷版本：

```bash
python batch_all_denoise.py --auto
```

### 2. 使用配置文件

```bash
python batch_all_denoise.py --config batch_denoise_config.json
```

### 3. 指定特定目录

```bash
python batch_all_denoise.py --dirs hyx_data lhr_data
```

## 当前数据目录

项目中当前包含以下数据目录：

- **hyx_data**: 13个文件（10个txt，3个png）
- **lhr_data**: 10个txt文件
- **lj_data**: 2个txt文件

总计：25个数据文件，可以一次性处理完成。

## 图形化界面

### 目录管理
- **自动扫描**：显示所有包含数据文件的 xxx_data 目录
- **选择控制**：勾选要处理的目录，取消勾选要跳过的目录
- **文件统计**：显示每个目录的数据文件数量

### 参数配置
- **基本参数**：采样率（100Hz）、PPG通道选择
- **降噪方法**：小波降噪或Bayesian降噪
- **小波参数**：小波类型（db6、sym8等）、分解层数（4层）
- **阈值策略**：通用阈值、Bayesian阈值或手动阈值
- **处理选项**：PPG降噪、IMU降噪分别控制

### 进度监控
- **实时进度**：显示当前处理进度和剩余时间
- **状态反馈**：每个目录的处理状态（成功/失败）
- **错误报告**：详细的错误信息和故障排除建议

## 输出结果

### 目录结构
```
batch_denoised_results/
└── batch_all_YYYYMMDD-HHMM/
    ├── batch_config.json          # 批量配置参数
    ├── batch_summary.txt          # 处理汇总报告
    ├── denoised_hyx_YYYYMMDD-HHMM/    # hyx_data 处理结果
    ├── denoised_lhr_YYYYMMDD-HHMM/    # lhr_data 处理结果
    └── denoised_lj_YYYYMMDD-HHMM/     # lj_data 处理结果
```

### 汇总报告内容
- **处理概览**：时间、配置、目录数量、成功率
- **详细结果**：每个目录的处理状态
- **错误记录**：失败原因和解决方案
- **统计信息**：处理效率和质量指标

### 单个目录结果
每个数据目录的处理结果包含：
- `denoising_summary.csv` - 详细的降噪效果统计
- `wavelet_config.json` - 使用的降噪参数
- `[文件名]_denoising_comparison.png` - 对比可视化图像

## 使用示例

### 示例1：处理所有目录（推荐）
```bash
python batch_all_denoise.py
```
启动GUI界面后：
1. 查看自动发现的目录列表
2. 确认要处理的目录（默认全选）
3. 设置降噪参数（使用默认推荐配置）
4. 点击"开始处理"按钮
5. 等待处理完成，查看结果

### 示例2：使用自定义配置
```bash
python batch_all_denoise.py --config batch_denoise_config.json
```
使用预设的配置，跳过GUI界面直接开始处理。

### 示例3：只处理特定目录
```bash
python batch_all_denoise.py --dirs hyx_data lj_data
```
只处理指定的目录，跳过其他目录。

## 配置参数

### 默认配置（推荐）
```json
{
  "fs": 100,
  "channel": "green",
  "wavelet": "db6",
  "decomposition_level": 4,
  "threshold": {
    "strategy": "universal",
    "scale": 1.0,
    "threshold_mode": "soft"
  },
  "ppg_denoise": true,
  "imu_denoise": true
}
```

### 参数说明
- **采样率 (fs)**: 数据采样频率，默认为100Hz
- **PPG通道**: 选择处理通道（green/ir/red）
- **小波类型**: 推荐db6或sym8
- **分解层数**: 通常4-6层，过大会过度平滑
- **阈值策略**: universal（自动）优于manual（手动）
- **阈值模式**: soft（软阈值）通常优于hard（硬阈值）

## 与单目录处理的对比

| 特性 | 单目录处理 | 批量处理 |
|------|------------|----------|
| 处理范围 | 单个目录 | 多个目录 |
| 目录发现 | 手动指定 | 自动发现 |
| 配置方式 | 每次单独配置 | 统一配置 |
| 输出结构 | 独立目录 | 统一汇总 |
| 进度显示 | 单个进度 | 批量进度 |
| 效率 | 需多次操作 | 一键完成 |
| 报告格式 | 单个CSV | 汇总TXT+多个CSV |

## 性能特点

### 处理效率
- **顺序处理**：依次处理每个目录，避免内存冲突
- **并行准备**：预处理完成后统一开始降噪
- **资源优化**：每个目录处理完成后释放内存

### 错误处理
- **独立处理**：单个目录失败不影响其他目录
- **详细日志**：记录每个目录的详细处理过程
- **错误恢复**：失败目录可单独重新处理

### 内存使用
- **峰值控制**：单个目录的内存使用量
- **渐进释放**：处理完一个目录后释放内存
- **适合大型数据集**：可处理大量数据文件

## 常见问题解决

### 1. 未发现数据目录
- 确保目录以 `_data` 结尾
- 检查目录包含 `.txt` 数据文件
- 确认在正确的项目根目录运行

### 2. 处理过程中断
- 单个目录失败不影响整体
- 查看汇总报告了解具体错误
- 失败目录可单独重新处理

### 3. 配置问题
- 检查配置文件JSON格式正确
- 确认参数值在有效范围内
- 使用默认配置测试基本功能

### 4. 内存不足
- 降低分解层数减少内存使用
- 关闭IMU降噪只处理PPG信号
- 分批处理大型数据集

## 技术原理

### 批量处理机制
1. **目录扫描**：遍历项目目录，识别所有 xxx_data 文件夹
2. **文件验证**：检查目录完整性和数据文件存在性
3. **参数统一**：所有目录使用相同的降噪参数
4. **顺序处理**：依次调用单目录处理脚本
5. **结果汇总**：收集所有处理结果生成统一报告

### 错误隔离
- **子进程调用**：每个目录使用独立进程处理
- **状态监控**：实时监控每个目录的处理状态
- **异常处理**：捕获并记录详细错误信息

## 降噪方法选择

### 小波降噪 (Wavelet Denoising)
- **原理**：使用小波变换将信号分解为不同频率成分，然后对细节系数进行阈值处理
- **阈值策略**：
  - **通用阈值**：σ√(2lnN)，适合大多数情况
  - **Bayesian阈值**：σ²/σ_universal，更保守的阈值
  - **手动阈值**：用户自定义阈值
- **阈值模式**：软阈值（连续）或硬阈值（不连续）
- **优势**：计算高效，适合实时处理

### Bayesian降噪 (Bayesian Denoising)
- **原理**：基于Bayesian统计理论的收缩阈值方法
- **特点**：
  - 自适应阈值计算
  - 考虑信号和噪声的统计特性
  - 更保守的噪声去除策略
- **优势**：在低信噪比情况下表现更好
- **适用场景**：噪声水平较高或信号特征较弱的情况

### 多通道处理
- **PPG通道**：同时处理green、ir、red三个通道
- **IMU数据**：支持ACC（X/Y/Z轴）和GYRO（X/Y/Z轴）数据
- **独立处理**：每个通道使用相同的参数但独立降噪
- **结果整合**：生成每个通道的降噪结果和对比图像

## 许可证

本工具遵循与原项目相同的许可证。

---

批量处理工具让您能够高效地处理所有数据目录，大大提高了工作效率！🎉
